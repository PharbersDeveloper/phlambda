AWSTemplateFormatVersion: 2010-09-09
Description: Submit Steps 20220614

Parameters:
  StateMachineName:
    Type: String
    Default: "alfredtest"
    Description: Equals to the current runnerId

  S3Bucket:
    Type: String
    Description: Dag Definition, generated by trigger lambda

  S3TemplateKey:
    Type: String
    Description: Dag Definition, generated by trigger lambda

  SubmitOwner:
    Type: String
    Default: "alfred"
    Description: somebody submit the job

Resources:
  Lmdphtestcodebuild:
    Type: AWS::Serverless::Function
    Properties:
      Handler: main.lambda_handler
      Runtime: python3.8
      AutoPublishAlias: Current
      CodeUri: s3://ph-platform/2020-11-11/cicd/deprecated/phtestcodebuild/samtem/dev/d9e5cfef801b4feb6fd643af1c494d33
      FunctionName: lmd-phtestcodebuild-dev
      Description: phtestcodebuild
      Role: arn:aws-cn:iam::444603803904:role/Ph-Back-RW
      MemorySize: 1024
      Timeout: 600
    Metadata:
      SamResourceId: ATTFFunction

  PhtestcodebuildStateMachine:
    Type: "AWS::StepFunctions::StateMachine"
    Properties:
      DefinitionS3Location:
        Bucket: !Ref S3Bucket
        Key: !Ref S3TemplateKey
      RoleArn: "arn:aws-cn:iam::444603803904:role/Ph-Data-Resource-Admin"
      StateMachineName: !Ref StateMachineName
      StateMachineType: STANDARD
      Tags:
        - Key: Tenrant
          Value: Pharbers
        - Key: Owner
          Value: !Ref SubmitOwner
        - Key: Name
          Value: !Ref "AWS::StackName"

Outputs:
  StateMachineARN:
    Description: State Machine Arn
    Value: !Ref PhtestcodebuildStateMachine
  StateMachineName:
    Description: State Machine Name
    Value: !Ref PhtestcodebuildStateMachine